# This script creates the server code for the Shiny application.

library(shiny)
library(dplyr)
library(plotly)
library(leaflet)
library(sf)
library(countrycode)
options(geonamesUsername="codrin")
library(geonames)


# Define server logic required to draw a histogram
shinyServer(function(input, output) {
  
  # Read in data generated by liveso.R
  df_merged <- readRDS("data/liveso_data.rds")
  world_sp <- as(df_merged, "Spatial")
  
  gdp_data <- readRDS("data/gdp_per_cap_data.rds")
  gini_data <- readRDS("data/gini_data.rds")
  hdi_data <- readRDS("data/hdi_data.rds")
  fp_data <- readRDS("data/fp_data.rds")
  fp_data$year <- as.numeric(fp_data$year)
  spi_data <- readRDS("data/spi_data.rds")
  
  # Create base map
  base_map <- world_sp %>%
                leaflet() %>%
                # addProviderTiles("Stamen.Watercolor", group = "Historical") %>%
                # addProviderTiles("Esri.WorldPhysical", group = "Physical") %>%
                addProviderTiles("OpenStreetMap.HOT", group = "Humanitarian") # %>% # https://www.hotosm.org
                # addLayersControl(baseGroups = c("Historical", "Physical", "NatGeo", "Humanitarian"))
  
  # World map with country polygons
  output$leaflet_world <- renderLeaflet({
    base_map %>%
      addPolygons(weight = 1, color = ~hpi_2016,
                  label = ~hover,
                  highlight = highlightOptions(weight = 5, color = "white",
                                               bringToFront = TRUE))
  })
  
  # Country specific data
  
  countrySelected <- eventReactive(input$leaflet_world_click, {
      # Get the click info like had been doing
      click <- input$leaflet_world_click
      clat <- click$lat
      clng <- click$lng
      
      # Lookup country
      countrycode(GNcountryCode(lat = clat, lng = clng)$countryCode, "iso2c", "iso3c")
  })
  
  # Index plot
  output$index_plot <- renderPlotly({
    country_gdp <- round(world_sp[world_sp$country_code == countrySelected()[[1]],]$gdp_scaled[1], 2)
    gdp_center <- attributes(world_sp$gdp_scaled)$`scaled:center`
    gdp_scale <- attributes(world_sp$gdp_scaled)$`scaled:scale`
    
    country_spi <- round(world_sp[world_sp$country_code == countrySelected()[[1]],]$spi_scaled[1], 2)
    spi_center <- attributes(world_sp$spi_scaled)$`scaled:center`
    spi_scale <- attributes(world_sp$spi_scaled)$`scaled:scale`
    
    country_fp <- round(world_sp[world_sp$country_code == countrySelected()[[1]],]$fp_scaled[1], 2)
    fp_center <- attributes(world_sp$fp_scaled)$`scaled:center`
    fp_scale <- attributes(world_sp$fp_scaled)$`scaled:scale`
    
    country_hpi <- round(world_sp[world_sp$country_code == countrySelected()[[1]],]$hpi_scaled[1], 2)
    hpi_center <- attributes(world_sp$hpi_scaled)$`scaled:center`
    hpi_scale <- attributes(world_sp$hpi_scaled)$`scaled:scale`
    
    plot_data <- data_frame("description" = c("Country GDP",
                                              "Country SPI",
                                              "Country FP",
                                              "Country HPI"),
                            "value" = c(country_gdp,
                                        country_spi,
                                        country_fp,
                                        country_hpi))
    
    ggplot(plot_data, aes(x = as.factor(description), y = value)) +
      geom_col() +
      ylab("Relative, normalized score (in standard deviations from the average 0)") +
      scale_y_continuous(limits = c(-2,2))
  })
  
### GDP TAB
  
  # GDP map
  output$econ_world <- renderLeaflet({
    base_map %>%
      addPolygons(weight = 1, color = ~gdp_2016,
                  label = ~hover,
                  highlight = highlightOptions(weight = 5, color = "white",
                                               bringToFront = TRUE))
  })
  
  # Country specific data
  
  gdpCountry <- eventReactive(input$econ_world_click, {
    # Get the click info like had been doing
    click <- input$econ_world_click
    clat <- click$lat
    clng <- click$lng
    
    # Lookup country
    countrycode(GNcountryCode(lat = clat, lng = clng)$countryCode, "iso2c", "iso3c")
  })
  
  # Create common plot scale
  
  x_axis <- list(autotick = FALSE,
                 ticks = "outside",
                 range = c(1960, 2020),
                 dtick = 5,
                 ticklen = 5,
                 tickwidth = 2,
                 tickcolor = toRGB("blue")
  )
  
  # GDP Plot
  output$gdp_plot <- renderPlotly({

    plot_ly(gdp_data[gdp_data$country_code == gdpCountry()[[1]], ], x = ~year, y = ~gdp_per_cap, name = gdpCountry()[[1]], type = "scatter", mode = "lines+markers") %>%
      layout(xaxis = x_axis)
    
  })
  
  # GINI Plot
  output$gini_plot <- renderPlotly({
    
    plot_ly(gini_data[gini_data$country_code == gdpCountry()[[1]], ], x = ~year, y = ~gini_avg, name = gdpCountry()[[1]], type = "scatter", mode = "lines+markers") %>%
      layout(xaxis = x_axis)
    
  })

### HDI TAB
  
  # EFP map
  output$hdi_world <- renderLeaflet({
    fp_map <- world_sp %>%
      leaflet() %>%
      addProviderTiles("Esri.NatGeoWorldMap", group = "NatGeo") %>%
      addPolygons(weight = 1, color = ~gdp_2016, label = ~hover,
                  highlight = highlightOptions(weight = 5, color = "white",
                                               bringToFront = TRUE))
    fp_map
  })
  
  # Country specific data
  
  hdiCountry <- eventReactive(input$hdi_world_click, {
    # Get the click info like had been doing
    click <- input$hdi_world_click
    print(click)
    clat <- click$lat
    clng <- click$lng
    
    # Lookup country
    countrycode(GNcountryCode(lat = clat, lng = clng)$countryCode, "iso2c", "iso3c")
  })
  
  # HDI Plot
  output$hdi_plot <- renderPlotly({
    
    plot_ly(hdi_data[hdi_data$country_code == hdiCountry()[[1]], ], x = ~year, y = ~hdi, name = hdiCountry()[[1]], type = "scatter", mode = "lines+markers") %>%
      layout(xaxis = x_axis)
    
  })
  
  
### SPI TAB CURRENTLY ONLY 2017 DATA OBTAINED

### EFP TAB
  
  # EFP map
  output$fp_world <- renderLeaflet({
    fp_map <- world_sp %>%
                 leaflet() %>%
                 addProviderTiles("Esri.NatGeoWorldMap", group = "NatGeo") %>%
                 addPolygons(weight = 1, color = ~gdp_2016, label = ~hover,
                             highlight = highlightOptions(weight = 5, color = "white",
                             bringToFront = TRUE))
    fp_map
  })
  
  # Country specific data
  
  fpCountry <- eventReactive(input$fp_world_click, {
    # Get the click info like had been doing
    click <- input$fp_world_click
    print(click)
    clat <- click$lat
    clng <- click$lng
    
    # Lookup country
    countrycode(GNcountryCode(lat = clat, lng = clng)$countryCode, "iso2c", "iso3c")
  })
  
  # FP Plot
  output$fp_plot <- renderPlotly({
    
    plot_ly(fp_data[fp_data$country_code == fpCountry()[[1]], ], x = ~year, y = ~fp, name = fpCountry()[[1]], type = "scatter", mode = "lines+markers") %>%
      layout(xaxis = x_axis)
    
  })
    
### HPI TAB
})
